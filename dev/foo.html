<!DOCTYPE html>
<html>	
	<head>
	<meta charset="utf-8">
	<title>bar test</title>
	<script src="https://code.jquery.com/jquery.js"></script>
	<script>
		window.onload = function() {
			console.log( "jQuery " + (window.jQuery ? "success" : "failure"));

			var filename = 'bar.txt';

			// Based on https://stackoverflow.com/questions/35135110/jquery-ajax-with-es6-promises
			// and http://www.sohamkamani.com/blog/2016/08/28/incremenal-tutorial-to-promises/
			function ajax( options ) { 
				// ajaxSetup eingefuegt fuer verarbeitung ohne shttp sondern via file://
				$.ajaxSetup({ dataType: 'text'});
				return new Promise( function( resolve, reject ) { 
					$.get( options ).done( resolve ).fail( reject );
				});
			}

			// to pass search and replace parameter into closure
			var loom = function( search, replace  ) { 
				return { 
					search: search,
					replace: replace
				}
			}

			var l = loom( 'This', 'VARIABLE'  );
			var doResolve = function ( data ) { 
				//var tmp = data.replace( cf1[0], cf1[1] );
				var tmp = data.replace( l.search, l.replace );
				console.log( l.search, "doResolve :", tmp );
				return tmp; // important for the second promise
			}

			var m = loom( 'content', 'OUTER RIM' );
			var doResolveNow = function ( data ) { 
				//var tmp = data.replace( cf1[0], cf1[1] );
				var tmp = data.replace( m.search, m.replace );
				console.log( m.search, "doResolveNow:", tmp );
				return tmp;
			}

			var doReject = function( data ) { 
				console.log( "Reject: ", data );
			}

			ajax( filename )
				.then( 
					doResolve,
					/* function( data ) { 
						var tmp = data.replace( 'content', 'BAAAR' );
						console.log( "2. resolve: ", tmp );
						return tmp;
					}, */
					doReject
					/* function( data ) { // reject
						console.log( "reject: ", data );
					} */
				)
				.then(  // work on the first promise result
					doResolveNow, 
					doReject
				).catch( function( error ) { 
					console.error( "Catched: ", error )
				} );
				//.catch( console.error.bind( console ) ); // works as well
		}	
	</script>
	</head>
	<body>
	</body>
</html>
