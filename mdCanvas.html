<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>MdCanvas</title>
	<link rel="stylesheet" href="mdCanvas.css" type="text/css" media="screen" charset="utf-8">
  	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
	<script src="mdCanvas.js"></script>
	<script src="mdfiles.js"></script>
  	<script src="https://cdn.rawgit.com/showdownjs/showdown/1.4.2/dist/showdown.min.js"></script>
  </head>
  <body>
  <div id="sidebar">
  <button id="toggler" onclick="">&laquo;</button>
	  <ul id="link" style="display:none">
	  </ul>
  </div>
  <div class="containerbox">
    <h1 id="mdc-canvas">LeanCanvas</h1>
    <div class="flex">
      <div id="mdc-problem">problem</div>
      <div class="box">
		  <div id="mdc-solution">solution</div>
		  <div id="mdc-key-metrics">key metrics</div>
	  </div>
      <div id="mdc-unique-value-proposition">unique-value-proposition</div>
      <div class="box">
		  <div id="mdc-unfair-advantage">unfair advantage</div>
		  <div id="mdc-channels">channels</div>
	  </div>
	  <div id="mdc-customer-segment">customer-segment</div>
    </div>
    <div class="flex">
      <div id="mdc-cost-structure">cost-structure</div>
      <div id="mdc-revenue-stream">revenue-stream</div>
    </div>
  	<div id="mdc-todo"></div>
  </div>
	
	<script type="text/javascript" charset="utf-8">

	// generate sections for the canvas
	function doSections( md ) { 
		var result = md.split( "#" );
		var sections = {  };
		// console.log( result );
		$.each( result, function( key, value ) { 
			if ( value != "" ) {  
				//console.log( key + ": " + value );

				// get the heading
				var header = value.split( "\n" );
				//console.log( key + ":" +header[0] );

				// add header to the section
				sections[objKey( header[0] )] = '###' + value;

				// get the name of the canvas or project name
				if ( header[0].includes( "anvas" ) ) { 
					sections[objKey( header[0] )] = header[1];
				}
			}
		} );
		return sections;
	}

	// generate object key
	function objKey( name ) { 
		return 'mdc-' + name.toLowerCase().trim();
	}

	// process the markdown content
	function showmd( value ) { 
		var sections = doSections( value );
		// console.log( sections );

		$.each( sections, function( key, value ) { 
			// console.log( key + ": " + value );
			var tagId = "#" + key;
			
			var sdown = new showdown.Converter(  ), text = value, html = sdown.makeHtml( text );
			$( tagId ).html( html );
		});
	}

	// get url parameter
	var md = getUrlParameter( "md" ) || "mdCanvas";
	var pathmd = md + ".md";

	// get markdown file and content
	$.get( pathmd, function( data ) {
		showmd( data );
	}, 'text');

	/****
	 * code to get a list of all lean canvas and link them! 
	 * does only work in the server context, not on the local file system
	 * And locally with a workaround of a windows batch file
	 ***/ 
	http://stackoverflow.com/a/23189786/1933185

	(function($) {
		
		var filenames = g_FOLDER_CONTENTS.match(/\S+/g);
		console.log( filenames );
		var cleanFilenames = $.map( filenames, function( n ) { 
			return( ( /readme/i ).test( n ) ? null : n );
			} );
		//console.log( cleanFilenames );
		$.each( cleanFilenames, function( key, value ) { 
			console.log( value );
			var li = $( '<li>' ).appendTo( '#link' );
			var name = value.slice( 0,-3 );
			// $( '<a>', { text: value, href: '?md=' + value.slice( 0,-3 ) } ).appendTo( '#link' );
			$( '<a>', { text: name, href: '?md=' + name } ).appendTo( li );
		});
	}( jQuery ));


	$( '#sidebar' ).click( function(  ) {  
		console.log( "just been NEW clicked" );
		var nsiba = new sideBarNew(  );
		nsiba.toggle(  );

		// @todo need a check when a new md is loaded how the state of the sidebar was
	});

	function sideBarNew(  )	{ 
		const stateClose = 'close'; // should be key not available
		const stateOpen = 'open';

		console.log( "I am a sidebar!" );

		// @todo do I need this?
		var widthpx = $( '#sidebar' ).css( 'width' );
		var width = widthpx.slice( 0, widthpx.length - 2 );
		width = Number( width );

		// capsulated the toggle function, so that is not called every time sbar(  ) is called
		/*
		function toggle(  ) {  
			if ( width < 30 ) { 
				openSidebar(  );
			} else { 
				closeSidebar(  );
			}
		}
		*/

		return {  

			open:  function(  ) { 
			   $( '#sidebar' ).css( 'width', 200 );
			   $( '#link' ).css( 'display', 'inline');
			   this.setState( stateOpen );
			},

			close: function (  ) { 
			   $( '#sidebar' ).css( 'width', 29 );
			   $( '#link' ).css( 'display', 'none');
			   this.setState( stateClose );
		   	},

			setState: function ( setState = stateOpen ) { 
				if ( setState == stateOpen ) {  
					localStorage.setItem( 'stateSidebar', stateOpen );
				} else {  
					// this has the advantage that a new loaded page and a closed sidebar have the same state
					localStorage.removeItem( 'stateSidebar' ); // value is null
				}

				// localStorage.setItem( 'stateSidebar', ( setState == stateClose ? stateClose : stateOpen ) );
				console.log( 'stateSidebar is now: ' + this.getState(  ) );
			}, 
			
			getState: function(  ) {
				return localStorage.getItem( 'stateSidebar' );
		    },

			toggle: function(  ) { 
				if ( this.getState(  ) == stateOpen ) { 
					this.close(  );
				} else { 
					this.open(  );
				}
			}




		}

	}

	

	/***** old code just commented to start new 
	(function($) {

	$( '#sidebar' ).click( function(  ) {  
		// @todo does not work: no access to sbar(  );
		// var sidebar = sbar(  );
		// sidebar.toggle(  );
		console.log( "just been clicked" );
	});
		
	

	// Closure: http://javascriptissexy.com/understand-javascript-closures-with-ease/
	function sbar(  )	{ 
		const stateClose = 'close';
		const stateOpen = 'open';

		var widthpx = $( '#sidebar' ).css( 'width' );
		var width = widthpx.slice( 0, widthpx.length - 2 );
		width = Number( width );

		// capsulated the toggle function, so that is not called every time sbar(  ) is called
		function toggle(  ) {  
			if ( width < 30 ) { 
				openSidebar(  );
			} else { 
				closeSidebar(  );
			}
		}

		// @todo rename to open(  )
		// so that it can be called with sbar.open(  )
		function openSidebar(  ) { 
			$( '#sidebar' ).css( 'width', 200 );
			$( '#link' ).css( 'display', 'inline');
			setStatusSidebar( stateOpen );
		}

		// @todo rename to close(  )
		function closeSidebar(  ) { 
			$( '#sidebar' ).css( 'width', 29 );
			$( '#link' ).css( 'display', 'none');
			setStatusSidebar( stateClose );
		}

		function setStatusSidebar( setState = 'folded' ) { 
			localStorage.setItem( 'statusSidebar', ( setState == stateClose ? stateClose : stateOpen ) );
			console.log( 'statusSidebar is now: ' + setState )
		}

		// @todo rename to checkStatus(  )
		function checkStatusSidebar(  ) { 

			// check local storage
			var currentState = localStorage.getItem( 'statusSidebar' );

			if ( currentState === null ) { 
				console.log( 'status of sidebar is not definied; so it shall be folded' );
				currentState = stateClose;
			} else { 
				console.log( 'status of sidebar is DEFINIED: ' + currentState );
			} 

			console.log( currentState );
			return currentState;
		}

	}


	}( jQuery ));
	*****/



	</script>
  </body>
</html>	
